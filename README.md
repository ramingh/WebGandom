# پروژه نقشه گندم
این پروژه یک سیستم مدیریت نقشه با استفاده از Leaflet است که برای نمایش و مدیریت فروشگاه‌ها و مکان‌های مختلف استفاده می‌شود.

## ساختار پروژه

## ویژگی‌های اصلی

### 1. مدیریت نقشه پایه
- پشتیبانی از چندین لایه نقشه پایه (OSM، ماهواره‌ای، توپوگرافی)
- امکان تغییر لایه‌های پایه به صورت پویا
- کنترل‌های زوم و پن در نقشه

### 2. جستجو و مسیریابی
- جستجوی مکان‌ها با پشتیبانی از زبان فارسی
- نمایش نتایج جستجو روی نقشه
- امکان تعیین مسیر و محاسبه فاصله

### 3. تحلیل کسب و کارها
- نمایش کسب و کارهای مختلف در محدوده مشخص
- دسته‌بندی کسب و کارها بر اساس نوع فعالیت
- نمایش اطلاعات دقیق هر کسب و کار شامل:
  - نام و آدرس
  - موقعیت جغرافیایی
  - فاصله از نقطه مرجع
  - اطلاعات تماس

### 4. گزارش‌گیری
- تولید گزارش خلاصه از کسب و کارهای موجود در محدوده
- امکان خروجی PDF از گزارش‌ها
- نمایش آمار و اطلاعات آماری

### 5. ابزارهای تحلیلی
- محاسبه تراکم جمعیت
- نمایش کد پستی مناطق
- نمایش اطلاعات آبادی‌ها
- تحلیل دسترسی‌پذیری

## تکنولوژی‌های استفاده شده

- Leaflet.js برای نمایش نقشه
- Vue.js برای رابط کاربری
- Map.ir API برای داده‌های جغرافیایی
- jsPDF برای تولید گزارش PDF

## نصب و راه‌اندازی

1. نصب وابستگی‌ها:
```bash
npm install
```

2. تنظیمات API:
- کلید API نقشه را در فایل تنظیمات وارد کنید
- تنظیمات سرویس‌های مورد نیاز را انجام دهید

3. اجرای برنامه:
```bash
npm run dev
```

## ساختار فایل‌ها

- `src/components/NewMap1.js`: کلاس اصلی مدیریت نقشه
- `src/assets/js/icons.js`: مدیریت آیکون‌ها و نام‌های فارسی
- `public/index.html`: فایل HTML اصلی
- `src/assets/css/style.css`: استایل‌های برنامه

## API های مورد استفاده

- Map.ir Places API
- Gandom GIS Services
- OpenStreetMap

## ویژگی‌های امنیتی

- احراز هویت API با استفاده از کلیدهای API
- محدودیت دسترسی به سرویس‌ها
- رمزنگاری داده‌های حساس

## پشتیبانی از مرورگرها

- Chrome (جدیدترین نسخه)
- Firefox (جدیدترین نسخه)
- Safari (جدیدترین نسخه)
- Edge (جدیدترین نسخه)

## محدودیت‌ها

- نیاز به اتصال اینترنت برای دریافت داده‌ها
- محدودیت در تعداد درخواست‌های API
- وابستگی به سرویس‌های خارجی برای برخی داده‌ها

## توسعه‌دهندگان

- تیم توسعه گندم
- پشتیبانی فنی: support@gandomcs.com

## لایسنس

این پروژه تحت لایسنس اختصاصی گندم منتشر شده است.

## توضیحات فنی NewMap1.js

کلاس `GandomMap` در فایل `NewMap1.js` هسته اصلی سیستم نقشه‌برداری گندم است. این کلاس تمام قابلیت‌های نقشه را مدیریت می‌کند.

### ساختار اصلی کلاس

#### 1. مدیریت نقشه پایه
- `constructor(containerId)`: مقداردهی اولیه نقشه و تنظیمات پایه
- `init()`: راه‌اندازی نقشه و افزودن کنترل‌های اصلی
- `initBaseMapControls()`: تنظیم کنترل‌های نقشه پایه
- `setBaseMap(type)`: تغییر نوع نقشه پایه

#### 2. کنترل‌های نقشه
- `addSearchControl()`: افزودن جستجوگر مکان
- `addRulerControl()`: افزودن ابزار اندازه‌گیری
- `initLayerToggleButton()`: دکمه نمایش/مخفی کردن لایه‌ها
- `initTrashButton()`: دکمه پاک کردن المان‌های نقشه

#### 3. مدیریت لایه‌ها
- `addLayer(id, layer, options)`: افزودن لایه جدید
- `removeLayer(id)`: حذف لایه
- `toggleLayer(layerId, visible)`: تغییر وضعیت نمایش لایه
- `showLayer(layerId)`: نمایش لایه
- `hideLayer(layerId)`: مخفی کردن لایه

#### 4. مدیریت نشانگرها
- `addMarker(latlng)`: افزودن نشانگر
- `removeMarker(id)`: حذف نشانگر
- `clearMarkers()`: پاک کردن همه نشانگرها
- `getMarkerIcon(type)`: دریافت آیکون مناسب برای نشانگر

#### 5. تحلیل داده‌ها
- `fetchLayerData(layerId)`: دریافت داده‌های لایه
- `createLayer(layerId, data)`: ایجاد لایه از داده‌ها
- `count_other()`: شمارش المان‌های مختلف در محدوده
- `showSummaryReport()`: نمایش گزارش خلاصه
- `showPopulationInfo()`: نمایش اطلاعات جمعیتی

#### 6. ابزارهای نقشه‌برداری
- `Draw_modir()`: رسم محدوده مدیریتی
- `cod_post()`: نمایش کد پستی
- `drawDistrict()`: رسم محدوده منطقه
- `drawVillages()`: رسم محدوده روستاها
- `Draw_abdi()`: رسم محدوده آبادی

#### 7. مدیریت کسب و کارها
- `addBusinessMarker()`: افزودن نشانگر کسب و کار
- `showReport()`: نمایش گزارش کسب و کار
- `getPersianName()`: تبدیل نام‌های انگلیسی به فارسی
- `geticon()`: دریافت آیکون مناسب برای نوع کسب و کار

#### 8. خروجی و گزارش‌گیری
- `exportToPDF()`: خروجی PDF از گزارش‌ها
- `initPDFExport()`: راه‌اندازی سیستم خروجی PDF

### نکات فنی مهم

1. **مدیریت حافظه**
   - پاکسازی خودکار نشانگرها و لایه‌ها
   - مدیریت بهینه منابع در زمان تغییر لایه‌ها

2. **بهینه‌سازی عملکرد**
   - استفاده از کش برای داده‌های پرتکرار
   - مدیریت هوشمند درخواست‌های API

3. **امنیت**
   - مدیریت کلیدهای API
   - محدودیت دسترسی به توابع حساس

4. **تعامل با کاربر**
   - رابط کاربری فارسی
   - پیام‌های خطای مناسب
   - راهنمایی‌های کاربردی

### محدودیت‌های فنی

1. **محدودیت‌های API**
   - تعداد درخواست‌های مجاز
   - محدودیت در حجم داده‌ها

2. **محدودیت‌های مرورگر**
   - نیاز به WebGL برای برخی قابلیت‌ها
   - محدودیت در تعداد لایه‌های همزمان

3. **محدودیت‌های داده**
   - وابستگی به کیفیت داده‌های ورودی
   - نیاز به به‌روزرسانی مداوم داده‌ها

## مدیریت متمرکز آیکون‌ها (icons.js)

### ساختار و سازماندهی آیکون‌ها
آیکون‌های پروژه در سه دسته اصلی در فایل `src/assets/js/icons.js` مدیریت می‌شوند:

1. **آیکون‌های پایه (`icons`)**
```javascript
const createIcon = (iconName) => L.icon({
    iconUrl: url_path + iconName,
    iconSize: [20, 30],
    popupAnchor: [0, 0]
});

export const icons = {
    vlag01_: createIcon('vilage1.png'),
    vilage1_: createIcon('vlag1.png'),
    // ... سایر آیکون‌های پایه
};
```

2. **آیکون‌های فروشگاه (`storeIcons`)**
```javascript
export const storeIcons = {
    Gandom_: L.icon({
        iconUrl: 'https://gis.gandomcs.com/arcgis/rest/services/IR22/MapServer/5/images/icon.png',
        iconSize: [32, 32],
        iconAnchor: [16, 32]
    }),
    // ... سایر آیکون‌های فروشگاه
};
```

3. **آیکون‌های دسته‌بندی (`categoryIcons`)**
```javascript
export const categoryIcons = {
    'hospital': L.divIcon({
        html: '<i class="fas fa-hospital" style="color: #FF4444;"></i>',
        className: 'category-marker hospital',
        iconSize: [20, 20]
    }),
    // ... سایر دسته‌بندی‌ها
};
```

### نحوه استفاده از آیکون‌ها

1. **در NewMap.js**
```javascript
import { categoryIcons } from '../assets/js/icons.js';

// دریافت آیکون دسته‌بندی
getCategoryIcon(category) {
    return categoryIcons[category] || categoryIcons.default;
}

// دریافت آیکون فروشگاه
getStoreIcon(stat) {
    switch (stat) {
        case "باز": return icons.Gandom_;
        case "بسته": return icons.Gandomb_;
        // ...
    }
}
```

2. **در LayerManager1.js**
```javascript
import icons from '../assets/js/icons.js';

// استفاده از آیکون‌ها در نشانگرها
L.marker(latlng, { icon: this.getStoreIcon(statos) })
```

### دسته‌بندی‌های موجود آیکون‌ها
- بیمارستان‌ها و مراکز درمانی
- مدارس و مراکز آموزشی
- مساجد و اماکن مذهبی
- مراکز خرید و فروشگاه‌ها
- حمل و نقل عمومی
- پارکینگ‌ها
- و غیره...

### نکات مهم در مدیریت آیکون‌ها
1. تمام آیکون‌ها باید در `icons.js` تعریف شوند
2. هر دسته‌بندی جدید باید در `categoryIcons` اضافه شود
3. برای هر دسته‌بندی یک آیکون پیش‌فرض تعریف شده است
4. سایز و رنگ آیکون‌ها باید استاندارد باشد
5. از Font Awesome برای آیکون‌های دسته‌بندی استفاده می‌شود

### مراحل اضافه کردن آیکون جدید
1. اضافه کردن تصویر آیکون به پوشه `IMG`
2. تعریف آیکون در دسته‌بندی مربوطه در `icons.js`
3. به‌روزرسانی مستندات و راهنمای استفاده

### تست و اعتبارسنجی
برای اطمینان از عملکرد صحیح، موارد زیر را تست کنید:
1. نمایش صحیح آیکون‌های فروشگاه در وضعیت‌های مختلف
2. نمایش صحیح آیکون‌های دسته‌بندی
3. عملکرد آیکون پیش‌فرض برای موارد نامعتبر
4. سازگاری با مرورگرهای مختلف

## ترتیب و اولویت لود شدن فایل‌ها

### 1. فایل‌های اصلی (به ترتیب اولویت)
1. `src/assets/js/icons.js`
   - تعریف آیکون‌های پایه
   - تعریف توابع کمکی ایجاد آیکون
   - export کردن آیکون‌ها برای استفاده در سایر فایل‌ها

2. `src/components/NewMap.js`
   - import کردن آیکون‌ها از `icons.js`
   - تعریف کلاس اصلی نقشه
   - راه‌اندازی اولیه نقشه

3. `src/components/LayerManager1.js`
   - import کردن آیکون‌ها از `icons.js`
   - وابسته به نمونه نقشه از `NewMap.js`
   - مدیریت لایه‌ها و کنترل‌ها

4. `src/assets/js/main.js`
   - نقطه ورود اصلی برنامه
   - ایجاد نمونه از کلاس‌های اصلی
   - راه‌اندازی برنامه

### 2. وابستگی‌های خارجی
- Leaflet.js
- Font Awesome (برای آیکون‌ها)
- سایر کتابخانه‌های مورد نیاز

## ترتیب اجرای توابع

### 1. راه‌اندازی اولیه
1. `main.js`: شروع برنامه
2. `GandomMap1.constructor()`: ایجاد نمونه نقشه
3. `GandomMap1.init()`: راه‌اندازی نقشه
4. `LayerManager.constructor()`: ایجاد مدیریت لایه‌ها

### 2. مدیریت نقشه (NewMap.js)
1. `initBaseMapControls()`: راه‌اندازی کنترل‌های پایه
2. `addSearchControl()`: اضافه کردن جستجو
3. `addRulerControl()`: اضافه کردن خط‌کش
4. `initLayerToggleButton()`: دکمه تغییر لایه‌ها

### 3. جستجو و نمایش فروشگاه‌ها
1. `find_market111(marketcode)`: جستجوی فروشگاه
   - `getStoreIcon(stat)`: دریافت آیکون مناسب
   - `draw_loc()`: نمایش موقعیت
   - نمایش پاپ‌آپ اطلاعات

### 4. مدیریت لایه‌ها (LayerManager1.js)
1. `initSearchBox()`: راه‌اندازی جستجو
2. `initToggleButton()`: دکمه نمایش/مخفی کردن
3. `loadLayers()`: بارگذاری لایه‌ها
   - `get_sql()`: دریافت داده‌ها
   - `renderLayers()`: نمایش لایه‌ها

### 5. نمایش مکان‌های دسته‌بندی شده
1. `fetchLocationDetails()`: دریافت اطلاعات مکان
   - `getCategoryIcon()`: دریافت آیکون دسته‌بندی
   - نمایش مارکر و پاپ‌آپ

### 6. عملیات تحلیلی
1. `Draw_buffer()`: رسم حریم
2. `Route_find()`: مسیریابی
3. `Draw_modir()`: رسم محدوده مدیریتی
4. `Draw_abdi()`: رسم محدوده آبادی

### 7. گزارش‌گیری
1. `showReport()`: نمایش گزارش
2. `exportToPDF()`: خروجی PDF
3. `drawTableRow()`: رسم جدول

### نکات مهم در ترتیب اجرا
1. اطمینان از لود شدن کامل نقشه قبل از عملیات دیگر
2. مدیریت صحیح رویدادهای ناهمگام (async/await)
3. اولویت‌بندی درخواست‌های API
4. پاکسازی منابع قبل از عملیات جدید

## تغییرات اخیر

### اصلاح مدیریت لایه فروشگاه‌های گندم

1. **اصلاح تابع `loadGandomStores`**
   - تغییر نحوه ذخیره‌سازی نقاط فروشگاه‌ها در `this.gandompoint1`
   - اضافه کردن لایه با وضعیت مخفی به نقشه
   - بهبود مدیریت خطاها
   - حذف تعریف تکراری `this.gandompoint1` (تعریف شده در constructor)

2. **اصلاح تابع `toggleLayer`**
   - اضافه کردن پشتیبانی از لایه `gandom_stores`
   - بهبود نمایش و مخفی کردن لایه `gandompoint1`
   - حذف تداخل با کنترل‌های لایه HTML

3. **اصلاح تابع `clearAllMarkers`**
   - اصلاح استفاده از `this.gandompoint1` به جای متغیر سراسری `gandompoint1`
   - بهبود مدیریت حذف لایه‌ها
   - اضافه کردن پیام‌های خطای مناسب

4. **حذف تابع `addLayerControls`**
   - حذف تابع اضافی `addLayerControls`
   - استفاده از کنترل‌های لایه HTML موجود
   - جلوگیری از تداخل با کنترل‌های لایه Leaflet

### نکات مهم
- استفاده از `this.gandompoint1` به جای متغیر سراسری `gandompoint1`
- بهبود مدیریت خطاها و پیام‌های کنسول
- بهینه‌سازی عملکرد با حذف کدهای تکراری
- تعریف `this.gandompoint1` فقط یک بار در constructor کلاس

### ساختار داده‌های فروشگاه‌های گندم
اطلاعات فروشگاه‌های گندم در متغیر `this.gandompoint1` ذخیره می‌شود که یک نمونه از `L.layerGroup` است. این متغیر شامل:
- موقعیت جغرافیایی هر فروشگاه (طول و عرض جغرافیایی)
- نام فروشگاه
- وضعیت فروشگاه (باز، بسته، در حال جمع آوری، در حال راه اندازی)
- کد فروشگاه
- منطقه جغرافیایی

این داده‌ها از API گندم دریافت می‌شوند و در `this.gandompoint1` ذخیره می‌شوند تا بتوان با تیک زدن کاربر، آنها را نمایش داد یا مخفی کرد.

### قابلیت‌های آینده
با توجه به ذخیره‌سازی مختصات فروشگاه‌ها، امکان پیاده‌سازی قابلیت‌های زیر وجود دارد:
1. **جستجوی نزدیک‌ترین فروشگاه**
   - محاسبه فاصله بین نقطه انتخاب شده و تمام فروشگاه‌ها
   - مرتب‌سازی بر اساس فاصله
   - نمایش نزدیک‌ترین فروشگاه‌ها

2. **فیلتر بر اساس وضعیت**
   - جستجوی نزدیک‌ترین فروشگاه‌های باز
   - جستجوی نزدیک‌ترین فروشگاه‌های بسته
   - جستجوی نزدیک‌ترین فروشگاه‌های در حال راه‌اندازی

3. **نمایش محدوده**
   - نمایش شعاع دسترسی به فروشگاه‌ها
   - نمایش محدوده تحت پوشش هر فروشگاه
   - محاسبه تراکم فروشگاه‌ها در مناطق مختلف