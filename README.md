# پروژه نقشه گندم
این پروژه یک سیستم مدیریت نقشه با استفاده از Leaflet است که برای نمایش و مدیریت فروشگاه‌ها و مکان‌های مختلف استفاده می‌شود.

## ساختار پروژه

```
WebGandom/
├── src/
│   ├── components/
│   │   ├── NewMap1.js
│   │   └── NewMap.js
│   ├── assets/
│   │   ├── js/
│   │   │   └── icons.js
│   │   └── css/
│   │       └── style.css
│   └── App.vue
├── public/
│   └── index.html
├── package.json
└── README.md
```

## ویژگی‌های اصلی

### 1. مدیریت نقشه پایه
- پشتیبانی از چندین لایه نقشه پایه (OSM، ماهواره‌ای، توپوگرافی)
- امکان تغییر لایه‌های پایه به صورت پویا
- کنترل‌های زوم و پن در نقشه

### 2. جستجو و مسیریابی
- جستجوی مکان‌ها با پشتیبانی از زبان فارسی
- نمایش نتایج جستجو روی نقشه
- امکان تعیین مسیر و محاسبه فاصله

### 3. تحلیل کسب و کارها
- نمایش کسب و کارهای مختلف در محدوده مشخص
- دسته‌بندی کسب و کارها بر اساس نوع فعالیت
- نمایش اطلاعات دقیق هر کسب و کار شامل:
  - نام و آدرس
  - موقعیت جغرافیایی
  - فاصله از نقطه مرجع
  - اطلاعات تماس

### 4. گزارش‌گیری
- تولید گزارش خلاصه از کسب و کارهای موجود در محدوده
- امکان خروجی PDF از گزارش‌ها
- نمایش آمار و اطلاعات آماری

### 5. ابزارهای تحلیلی
- محاسبه تراکم جمعیت
- نمایش کد پستی مناطق
- نمایش اطلاعات آبادی‌ها
- تحلیل دسترسی‌پذیری

## تکنولوژی‌های استفاده شده

- Leaflet.js برای نمایش نقشه
- Vue.js برای رابط کاربری
- Map.ir API برای داده‌های جغرافیایی
- jsPDF برای تولید گزارش PDF

## نصب و راه‌اندازی

1. نصب وابستگی‌ها:
```bash
npm install
```

2. تنظیمات API:
- کلید API نقشه را در فایل `src/components/NewMap1.js` وارد کنید:
```javascript
const MAP_IR_API_KEY = 'your-api-key-here';
```

3. تنظیمات محیطی:
- فایل `.env` را در ریشه پروژه ایجاد کنید:
```
VUE_APP_MAP_IR_API_KEY=your-api-key-here
VUE_APP_API_BASE_URL=https://api.map.ir
```

4. اجرای برنامه:
```bash
npm run dev
```

5. ساخت نسخه تولید:
```bash
npm run build
```

## وابستگی‌های اصلی

```json
{
  "dependencies": {
    "leaflet": "^1.9.4",
    "vue": "^3.3.4",
    "jspdf": "^2.5.1",
    "axios": "^1.6.2"
  }
}
```

## تنظیمات پیش‌فرض

### نقشه پایه
- مرکز پیش‌فرض: تهران (35.6892° N, 51.3890° E)
- سطح زوم پیش‌فرض: 13
- محدوده زوم: 5 تا 18

### لایه‌های پیش‌فرض
- OpenStreetMap
- ماهواره‌ای
- توپوگرافی

### تنظیمات API
- محدودیت درخواست: 1000 درخواست در روز
- زمان timeout: 30 ثانیه
- تعداد نتایج جستجو: حداکثر 10 نتیجه

## عیب‌یابی

### مشکلات رایج
1. **خطای CORS**
   - اطمینان از تنظیم صحیح CORS در سرور
   - بررسی تنظیمات proxy در `vue.config.js`

2. **خطای API**
   - بررسی اعتبار کلید API
   - اطمینان از فعال بودن سرویس‌های مورد نیاز

3. **مشکلات نمایش نقشه**
   - بررسی اتصال اینترنت
   - پاک کردن کش مرورگر
   - بررسی تنظیمات WebGL

### لاگ‌ها
- لاگ‌های خطا در کنسول مرورگر
- فایل‌های لاگ در `logs/` (در محیط تولید)

## بهینه‌سازی

### عملکرد
- استفاده از lazy loading برای لایه‌ها
- کش‌گذاری داده‌های پرتکرار
- بهینه‌سازی درخواست‌های API

### امنیت
- رمزنگاری کلیدهای API
- محدودیت دسترسی به توابع حساس
- اعتبارسنجی داده‌های ورودی

## ساختار فایل‌ها

- `src/components/NewMap1.js`: کلاس اصلی مدیریت نقشه
- `src/assets/js/icons.js`: مدیریت آیکون‌ها و نام‌های فارسی
- `public/index.html`: فایل HTML اصلی
- `src/assets/css/style.css`: استایل‌های برنامه

## API های مورد استفاده

- Map.ir Places API
- Gandom GIS Services
- OpenStreetMap

## ویژگی‌های امنیتی

- احراز هویت API با استفاده از کلیدهای API
- محدودیت دسترسی به سرویس‌ها
- رمزنگاری داده‌های حساس

## پشتیبانی از مرورگرها

- Chrome (جدیدترین نسخه)
- Firefox (جدیدترین نسخه)
- Safari (جدیدترین نسخه)
- Edge (جدیدترین نسخه)

## محدودیت‌ها

- نیاز به اتصال اینترنت برای دریافت داده‌ها
- محدودیت در تعداد درخواست‌های API
- وابستگی به سرویس‌های خارجی برای برخی داده‌ها

## توسعه‌دهندگان

- تیم توسعه گندم
- پشتیبانی فنی: support@gandomcs.com

## لایسنس

این پروژه تحت لایسنس اختصاصی گندم منتشر شده است.

## بررسی فایل NewMap.js

### ساختار کلی
فایل `src/components/NewMap.js` یکی از فایل‌های اصلی پروژه است که مدیریت نقشه و قابلیت‌های آن را بر عهده دارد. این فایل شامل کلاس `GandomMap1` است که تمام قابلیت‌های نقشه را مدیریت می‌کند.

### کلاس‌های اصلی

#### 1. کلاس `GandomMap1`
این کلاس هسته اصلی مدیریت نقشه است و شامل توابع زیر می‌شود:

##### مدیریت نقشه پایه
- `constructor(containerId)`: مقداردهی اولیه نقشه و تنظیمات پایه
- `init()`: راه‌اندازی نقشه و کنترل‌ها
- `initBaseMapControls()`: تنظیم کنترل‌های پایه
- `setBaseMap(type)`: تغییر نوع نقشه پایه

##### مدیریت لایه‌ها
- `addLayer(id, layer, options)`: افزودن لایه جدید
- `removeLayer(id)`: حذف لایه
- `toggleLayer(layerId, visible)`: تغییر وضعیت نمایش لایه
- `showLayer(layerId)`: نمایش لایه
- `hideLayer(layerId)`: مخفی کردن لایه

##### مدیریت نشانگرها
- `addMarker(latlng)`: افزودن نشانگر
- `removeMarker(id)`: حذف نشانگر
- `clearMarkers()`: پاک کردن همه نشانگرها
- `getMarkerIcon(type)`: دریافت آیکون مناسب

##### تحلیل داده‌ها
- `fetchLayerData(layerId)`: دریافت داده‌های لایه
- `createLayer(layerId, data)`: ایجاد لایه از داده‌ها
- `count_other()`: شمارش المان‌ها
- `showSummaryReport()`: نمایش گزارش خلاصه

##### ابزارهای نقشه‌برداری
- `Draw_modir()`: رسم محدوده مدیریتی
- `cod_post()`: نمایش کد پستی
- `drawDistrict()`: رسم محدوده منطقه
- `drawVillages()`: رسم محدوده روستاها
- `Draw_abdi()`: رسم محدوده آبادی

##### مدیریت کسب و کارها
- `addBusinessMarker()`: افزودن نشانگر کسب و کار
- `showReport()`: نمایش گزارش کسب و کار
- `getPersianName()`: تبدیل نام‌های انگلیسی به فارسی
- `geticon()`: دریافت آیکون مناسب

##### خروجی و گزارش‌گیری
- `exportToPDF()`: خروجی PDF از گزارش‌ها
- `initPDFExport()`: راه‌اندازی سیستم خروجی PDF

### نکات فنی مهم

#### 1. مدیریت حافظه
- پاکسازی خودکار نشانگرها و لایه‌ها
- مدیریت بهینه منابع در زمان تغییر لایه‌ها

#### 2. بهینه‌سازی عملکرد
- استفاده از کش برای داده‌های پرتکرار
- مدیریت هوشمند درخواست‌های API

#### 3. امنیت
- مدیریت کلیدهای API
- محدودیت دسترسی به توابع حساس

#### 4. تعامل با کاربر
- رابط کاربری فارسی
- پیام‌های خطای مناسب
- راهنمایی‌های کاربردی

### محدودیت‌های فنی

#### 1. محدودیت‌های API
- تعداد درخواست‌های مجاز
- محدودیت در حجم داده‌ها

#### 2. محدودیت‌های مرورگر
- نیاز به WebGL برای برخی قابلیت‌ها
- محدودیت در تعداد لایه‌های همزمان

#### 3. محدودیت‌های داده
- وابستگی به کیفیت داده‌های ورودی
- نیاز به به‌روزرسانی مداوم داده‌ها

### نحوه استفاده

#### 1. ایجاد نمونه از نقشه
```javascript
const map = new GandomMap1('map-container');
map.init();
```

#### 2. افزودن لایه
```javascript
map.addLayer('my-layer', layer, {
    visible: true,
    opacity: 0.8
});
```

#### 3. مدیریت نشانگرها
```javascript
map.addMarker([35.6892, 51.3890]);
map.clearMarkers();
```

#### 4. گزارش‌گیری
```javascript
map.showReport();
map.exportToPDF();
```

### نکات توسعه

1. **اضافه کردن قابلیت جدید**
   - ایجاد تابع جدید در کلاس `GandomMap1`
   - اضافه کردن کنترل‌های مربوطه
   - به‌روزرسانی مستندات

2. **اصلاح باگ**
   - بررسی لاگ‌های خطا
   - تست در محیط توسعه
   - اعمال اصلاحات

3. **بهینه‌سازی**
   - بررسی عملکرد
   - بهینه‌سازی کد
   - تست مجدد

### تست و اعتبارسنجی

1. **تست واحد**
   - تست توابع اصلی
   - تست مدیریت خطا
   - تست عملکرد

2. **تست یکپارچه**
   - تست تعامل با سایر بخش‌ها
   - تست عملکرد کلی
   - تست در مرورگرهای مختلف

3. **تست کاربری**
   - تست رابط کاربری
   - تست تجربه کاربری
   - تست کارایی

### تغییرات اخیر

#### 1. اصلاح مدیریت لایه فروشگاه‌های گندم
- تغییر نحوه ذخیره‌سازی نقاط فروشگاه‌ها در `this.gandompoint1`
- اضافه کردن لایه با وضعیت مخفی به نقشه
- بهبود مدیریت خطاها
- حذف تعریف تکراری `this.gandompoint1`

#### 2. اصلاح تابع `toggleLayer`
- اضافه کردن پشتیبانی از لایه `gandom_stores`
- بهبود نمایش و مخفی کردن لایه `gandompoint1`
- حذف تداخل با کنترل‌های لایه HTML

#### 3. اصلاح تابع `clearAllMarkers`
- اصلاح استفاده از `this.gandompoint1` به جای متغیر سراسری `gandompoint1`
- بهبود مدیریت حذف لایه‌ها
- اضافه کردن پیام‌های خطای مناسب

#### 4. حذف تابع `addLayerControls`
- حذف تابع اضافی `addLayerControls`
- استفاده از کنترل‌های لایه HTML موجود
- جلوگیری از تداخل با کنترل‌های لایه Leaflet

### نکات مهم
- استفاده از `this.gandompoint1` به جای متغیر سراسری `gandompoint1`
- بهبود مدیریت خطاها و پیام‌های کنسول
- بهینه‌سازی عملکرد با حذف کدهای تکراری
- تعریف `this.gandompoint1` فقط یک بار در constructor کلاس

### ساختار داده‌های فروشگاه‌های گندم
اطلاعات فروشگاه‌های گندم در متغیر `this.gandompoint1` ذخیره می‌شود که یک نمونه از `L.layerGroup` است. این متغیر شامل:
- موقعیت جغرافیایی هر فروشگاه (طول و عرض جغرافیایی)
- نام فروشگاه
- وضعیت فروشگاه (باز، بسته، در حال جمع آوری، در حال راه اندازی)
- کد فروشگاه
- منطقه جغرافیایی

این داده‌ها از API گندم دریافت می‌شوند و در `this.gandompoint1` ذخیره می‌شوند تا بتوان با تیک زدن کاربر، آنها را نمایش داد یا مخفی کرد.

### قابلیت‌های آینده
با توجه به ذخیره‌سازی مختصات فروشگاه‌ها، امکان پیاده‌سازی قابلیت‌های زیر وجود دارد:
1. **جستجوی نزدیک‌ترین فروشگاه**
   - محاسبه فاصله بین نقطه انتخاب شده و تمام فروشگاه‌ها
   - مرتب‌سازی بر اساس فاصله
   - نمایش نزدیک‌ترین فروشگاه‌ها

2. **فیلتر بر اساس وضعیت**
   - جستجوی نزدیک‌ترین فروشگاه‌های باز
   - جستجوی نزدیک‌ترین فروشگاه‌های بسته
   - جستجوی نزدیک‌ترین فروشگاه‌های در حال راه‌اندازی

3. **نمایش محدوده**
   - نمایش شعاع دسترسی به فروشگاه‌ها
   - نمایش محدوده تحت پوشش هر فروشگاه
   - محاسبه تراکم فروشگاه‌ها در مناطق مختلف