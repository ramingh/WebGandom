# سیستم نقشه تعاملی گندم (GandomMap)

## معرفی
این پروژه یک سیستم نقشه تعاملی برای مدیریت و نمایش اطلاعات مکانی است که با استفاده از Leaflet.js پیاده‌سازی شده است.

## ویژگی‌های اصلی

### 1. مدیریت لایه‌ها
- نمایش فروشگاه‌های زنجیره‌ای مختلف (گندم، افق کوروش، جانبو و...)
- امکان فعال/غیرفعال کردن لایه‌ها
- نمایش اطلاعات تراکم جمعیتی
- نمایش محدوده‌های کد پستی
- نمایش اطلاعات دهستان‌ها و روستاها

### 2. ابزارهای تعاملی
- جستجوی مکان
- اندازه‌گیری فاصله و مساحت
- تغییر نقشه پایه (OpenStreetMap, Satellite, Terrain)
- ابزار ترسیم اشکال مختلف

### 3. تحلیل داده‌ها
- محاسبه تراکم جمعیتی
- یافتن نزدیک‌ترین فروشگاه گندم
- شمارش و دسته‌بندی کسب و کارهای اطراف
- تحلیل دسترسی و مسیریابی

## ساختار کد

### کلاس اصلی: `GandomMap1`
```javascript
class GandomMap1 {
    constructor(containerId)
    init()
    loadGandomStores()
    // ... سایر متدها
}
```

### توابع کلیدی

#### 1. دریافت اطلاعات جامع (`get_alldata`)
```javascript
async get_alldata(longitude) {
    // دریافت اطلاعات:
    - کسب و کارهای اطراف
    - تراکم جمعیتی
    - نزدیک‌ترین فروشگاه گندم
    - اطلاعات کد پستی
    - اطلاعات دهستان
}
```

#### 2. مدیریت فروشگاه‌ها
- `loadGandomStores()`: بارگذاری فروشگاه‌های گندم
- `fetchAllStores()`: دریافت اطلاعات همه فروشگاه‌ها
- `findNearestStore()`: یافتن نزدیک‌ترین فروشگاه

#### 3. تحلیل جمعیتی
- `drawPopulationDensity()`: نمایش تراکم جمعیتی
- `drawDistrict()`: نمایش اطلاعات دهستان
- `drawVillages()`: نمایش آبادی‌ها

#### 4. مدیریت کسب و کارها
- `allbisinespoint()`: دریافت کسب و کارهای اطراف
- `count_other()`: شمارش کسب و کارها
- `fetchLocationDetails()`: دریافت جزئیات مکان‌ها

## نکات مهم پیاده‌سازی

### 1. مدیریت خطا
- بررسی داده‌های ورودی
- مدیریت خطاهای API
- لاگ‌گیری مناسب

### 2. بهینه‌سازی عملکرد
- استفاده از Promise.all برای درخواست‌های همزمان
- مدیریت حافظه با پاکسازی مارکرها
- کش کردن داده‌های پرکاربرد

### 3. امنیت
- استفاده از API Key
- اعتبارسنجی داده‌های ورودی
- محدودیت دسترسی به API‌ها

## وابستگی‌ها
- Leaflet.js
- jQuery
- Font Awesome (برای آیکون‌ها)

## API‌های مورد استفاده
1. Map.ir API
   - سرویس جستجوی مکان
   - سرویس مسیریابی
   - سرویس کسب و کارها

2. سرویس‌های داخلی گندم
   - سرویس فروشگاه‌ها
   - سرویس تراکم جمعیتی
   - سرویس کد پستی
   - سرویس دهستان‌ها

## نحوه استفاده

### 1. راه‌اندازی
```javascript
const map = new GandomMap1('map-container');
map.init();
```

### 2. دریافت اطلاعات جامع
```javascript
const data = await map.get_alldata([lat, lng]);
```

### 3. مدیریت لایه‌ها
```javascript
map.toggleLayer('gandom_stores', true);
map.toggleLayer('population_density', true);
```

## نگهداری و توسعه

### 1. افزودن لایه جدید
1. تعریف در `STORE_LAYERS`
2. اضافه کردن آیکون در `icons.js`
3. پیاده‌سازی منطق نمایش در `toggleLayer`

### 2. افزودن ابزار جدید
1. اضافه کردن در `iconservice`
2. پیاده‌سازی منطق در کلاس اصلی
3. اضافه کردن event listener

## مشکلات شناخته شده و راه‌حل‌ها

1. تأخیر در بارگذاری داده‌ها
   - استفاده از lazy loading
   - نمایش loading indicator

2. محدودیت‌های API
   - مدیریت rate limiting
   - کش کردن داده‌ها

3. مصرف حافظه
   - پاکسازی منظم مارکرها
   - مدیریت event listener‌ها

## نکات امنیتی

1. API Key
   - نگهداری در محیط امن
   - عدم نمایش در کد front-end

2. CORS
   - تنظیم headers مناسب
   - محدودیت دامنه‌های مجاز

3. داده‌های حساس
   - رمزنگاری در انتقال
   - محدودیت دسترسی

## بهینه‌سازی‌های آینده

1. عملکرد
   - استفاده از Web Workers
   - بهینه‌سازی درخواست‌های شبکه

2. UI/UX
   - بهبود رابط کاربری
   - اضافه کردن انیمیشن‌ها

3. قابلیت‌ها
   - تحلیل‌های پیشرفته‌تر
   - گزارش‌گیری جامع‌تر

## پشتیبانی مرورگرها
- Chrome 60+
- Firefox 55+
- Safari 11+
- Edge 79+
